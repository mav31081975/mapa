<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">

<!-- Viewport “duro” para que en mobile no haga zoom ni recortes raros -->
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
               user-scalable=no, viewport-fit=cover">

<title>Geo-Explorer • JPG + Fronteras (Opción A Estable)</title>

<!-- D3 + TopoJSON SOLO para dibujar fronteras -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>

<style>
:root {
  --accent: #00ffcc; /* color “HUD” */
}

/* ================= BASE ================= */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100dvh;          /* alto real visible (Android moderno) */
  overflow: hidden;
  background: #000;
  font-family: monospace;
}

#map-container {
  position: relative;      /* permite superponer SVG y panel */
  width: 100vw;
  height: 100dvh;
  touch-action: none;      /* evita gestos del navegador */
  cursor: crosshair;
}

/* ================= MAPA JPG (REFERENCIA REAL) ================= */
#world-map {
  width: 100%;
  height: 100%;
  object-fit: fill;        /* CRÍTICO: estira X/Y y coincide con el cálculo lat/lon */
  display: block;
}

/* ================= SVG SUPERPUESTO (VISUAL ONLY) ================= */
#borders-svg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;    /* NO interfiere con mouse/touch */
  z-index: 2;              /* por encima del JPG */
}

/* Fronteras (solo línea) */
.border {
  fill: none;
  stroke: rgba(255, 255, 255, 0.65); /* blanco contrastante */
  stroke-width: 1.2px;
  vector-effect: non-scaling-stroke; /* mantiene grosor al escalar */
}

/* ================= PANEL ================= */
#info-panel {
  position: absolute;
  width: 320px;
  padding: 16px;
  background: rgba(15,15,15,0.8);
  border: 1px solid rgba(0,255,204,0.4);
  color: #fff;
  z-index: 10;             /* por encima de todo */
  transition: transform 0.4s ease;
}

.label {
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--accent);
}
.value {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
}
.coords {
  display: flex;
  gap: 16px;
}

/* Posiciones del panel (salta por esquinas) */
.pos-tl { top: 15px; left: 15px; }
.pos-tr { top: 15px; left: calc(100% - 355px); }
.pos-bl { top: calc(100% - 150px); left: 15px; }
.pos-br { top: calc(100% - 150px); left: calc(100% - 355px); }

/* Mobile: panel un poco más chico */
body.is-mobile #info-panel {
  width: 240px;
}
</style>
</head>

<body>

<div id="map-container">

  <!-- MAPA JPG (BASE) -->
  <img
    id="world-map"
    src="https://upload.wikimedia.org/wikipedia/commons/8/83/Equirectangular_projection_SW.jpg"
    alt="Mapa mundial">

  <!-- SVG DE FRONTERAS (SOLO VISUAL) -->
  <svg id="borders-svg"></svg>

  <!-- PANEL -->
  <div id="info-panel" class="pos-tr">
    <div class="label">UBICACIÓN POLÍTICA</div>
    <div id="country-name" class="value">CARGANDO…</div>

    <div class="coords">
      <div>
        <div class="label">LATITUD</div>
        <div id="lat-val" class="value">0.00°</div>
      </div>
      <div>
        <div class="label">LONGITUD</div>
        <div id="lon-val" class="value">0.00°</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =====================================================
   REFERENCIAS (TU LÓGICA ORIGINAL)
   ===================================================== */
const mapImg = document.getElementById("world-map");
const panel = document.getElementById("info-panel");
const countryText = document.getElementById("country-name");
const latText = document.getElementById("lat-val");
const lonText = document.getElementById("lon-val");

const positions = ["pos-tl","pos-tr","pos-br","pos-bl"]; // ciclo de posiciones
let posIdx = 1;                                          // arranca en TR
let jumping = false;                                     // evita saltos seguidos
let ticking = false;                                     // throttle con rAF

/* ================= MOBILE DETECTION ================= */
const isMobile =
  ("ontouchstart" in window) ||
  (navigator.maxTouchPoints > 0);

if (isMobile) document.body.classList.add("is-mobile");

/* =====================================================
   PANEL MOVE (IGUAL QUE ANTES)
   ===================================================== */
function movePanel() {
  if (jumping) return;
  jumping = true;
  panel.classList.remove(positions[posIdx]);
  posIdx = (posIdx + 1) % positions.length;
  panel.classList.add(positions[posIdx]);
  setTimeout(() => jumping = false, 400);
}

/* =====================================================
   UPDATE UI — REFERENCIA: JPG
   ===================================================== */
function updateUI(clientX, clientY) {
  const rect = mapImg.getBoundingClientRect();
  const x = clientX - rect.left;
  const y = clientY - rect.top;

  // si estoy fuera del mapa, no actualizo nada
  if (x < 0 || y < 0 || x > rect.width || y > rect.height) {
    ticking = false;
    return;
  }

  // conversión lineal equirectangular (coincide con object-fit: fill)
  const lon = (x / rect.width) * 360 - 180;
  const lat = 90 - (y / rect.height) * 180;

  latText.textContent = lat.toFixed(4);
  lonText.textContent = lon.toFixed(4);

  ticking = false;
}

/* =====================================================
   EVENTOS (IGUALES A TU BASE)
   ===================================================== */
if (!isMobile) {
  // PC: uso pointermove + rAF para no saturar
  window.addEventListener("pointermove", e => {
    if (!ticking) {
      requestAnimationFrame(() => updateUI(e.clientX, e.clientY));
      ticking = true;
    }
  });
  // al pasar por arriba del panel, lo corro
  panel.addEventListener("mouseenter", movePanel);
} else {
  // Android: uso touchmove directo (y corro panel si el dedo lo toca)
  window.addEventListener("touchmove", e => {
    const t = e.touches[0];
    updateUI(t.clientX, t.clientY);

    const r = panel.getBoundingClientRect();
    if (
      t.clientX >= r.left &&
      t.clientX <= r.right &&
      t.clientY >= r.top &&
      t.clientY <= r.bottom
    ) {
      movePanel();
    }
  }, { passive:false });

  // tap al panel = lo mueve
  panel.addEventListener("touchstart", e => {
    e.preventDefault();
    movePanel();
  }, { passive:false });
}

/* =====================================================
   FRONTERAS VECTORIALES (SOLO DIBUJO)
   ===================================================== */
const svg = d3.select("#borders-svg");

// proyección lineal a pixeles (misma lógica que lon/lat del JPG)
function project([lon, lat]) {
  const w = svg.node().clientWidth;
  const h = svg.node().clientHeight;
  return [
    (lon + 180) / 360 * w,
    (90 - lat) / 180 * h
  ];
}

// path custom: transforma lon/lat a pixeles “estirados” como el JPG
const path = d3.geoPath().projection({
  stream: stream => ({
    point(lon, lat) {
      const [x, y] = project([lon, lat]);
      stream.point(x, y);
    },
    lineStart: () => stream.lineStart(),
    lineEnd: () => stream.lineEnd(),
    polygonStart: () => stream.polygonStart(),
    polygonEnd: () => stream.polygonEnd()
  })
});

// carga de dataset y dibujo de paths una sola vez
d3.json("https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json")
  .then(world => {
    const features = topojson
      .feature(world, world.objects.countries)
      .features;

    svg
      .attr("width", "100%")
      .attr("height", "100%");

    svg.selectAll("path")
      .data(features)
      .enter()
      .append("path")
      .attr("class", "border")
      .attr("d", path);
  });

// si cambia el tamaño, recalculo el "d" con el nuevo width/height
window.addEventListener("resize", () => {
  svg.selectAll("path").attr("d", path);
});
</script>

</body>
</html>
